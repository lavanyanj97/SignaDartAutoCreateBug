trigger:
- main  # Trigger on changes to the main branch

pool:
  vmImage: 'ubuntu-latest'  # Use an Ubuntu VM image for the pipeline

variables:
  pythonVersion: '3.x'  # Specify the Python version to use
  bugType: 'Bug'  # Set the work item type (Bug)

steps:
  # Install the specified Python version
  - task: UsePythonVersion@0
    inputs:
      versionSpec: $(pythonVersion)
      addToPath: true

  # Install Google Chrome on the Ubuntu agent
  - script: |
      sudo apt-get update
      sudo apt-get install -y google-chrome-stable
    displayName: 'Install Google Chrome'

  # Install dependencies from requirements.txt
  - script: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
    displayName: 'Install Python Dependencies'

  # Run the Selenium tests with pytest
  - script: |
      pytest test_update.py --maxfail=1 --disable-warnings -q > test_results.log 2>&1
      echo $? > pytest_exit_code.txt
    displayName: 'Run Selenium Tests'

  # Check if tests passed or failed, then raise a bug if failed
  - script: |
      exit_code=$(cat pytest_exit_code.txt)
      if [ $exit_code -ne 0 ]; then
        echo "Tests failed. Creating a bug in Azure DevOps..."

        # Escape the test results log to avoid breaking JSON
        log_output=$(cat test_results.log | sed 's/"/\\"/g')

        # Use Azure DevOps REST API to create a bug
        curl -X POST -H "Content-Type: application/json" \
          -H "Authorization: Bearer $(azureDevOpsPAT)" \
          --data "{
            \"fields\": {
              \"System.Title\": \"Automated Test Failure: Selenium Tests\",
              \"System.Description\": \"The Selenium tests failed during the pipeline execution. Please investigate the issue.\\n\\nLog output:\\n$log_output\",
              \"System.Tags\": \"Automated; Bug\"
            }
          }" \
          "https://dev.azure.com/SignaTechServicesIndia/SignaDart/_apis/wit/workitems/$bugType?api-version=6.0"

        exit $exit_code
      else
        echo "All tests passed successfully."
      fi
    displayName: 'Check Test Results and Raise Bug'
    env:
      azureDevOpsPAT: $(azureDevOpsPAT)
